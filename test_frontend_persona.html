<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海王对战测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .persona-option {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .persona-option:hover {
            background: #e0e0e0;
        }
        .persona-option.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        .system-message {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .chat-area {
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>海王对战前端测试</h1>
    
    <div class="test-section">
        <h3>模式选择</h3>
        <div class="persona-option" data-button-type="正常聊天">💬 正常聊天</div>
        <div class="persona-option" data-button-type="🌊对战海王">🌊 对战海王</div>
        <div class="persona-option" data-button-type="🍵反茶艺大师">🍵 反茶艺大师</div>
        <div class="persona-option" data-button-type="🌈决战通讯录之巅">🌈 决战通讯录之巅</div>
    </div>
    
    <div class="test-section">
        <h3>当前状态</h3>
        <div id="currentStatus">模式: 正常聊天</div>
        <div id="currentPersona">人设: 无</div>
    </div>
    
    <div class="test-section">
        <h3>聊天区域</h3>
        <div id="chatArea" class="chat-area"></div>
    </div>
    
    <div class="test-section">
        <h3>测试按钮</h3>
        <button onclick="testPersonaFetch()">测试获取人设</button>
        <button onclick="clearChat()">清空聊天</button>
    </div>

    <script>
        let currentButtonType = '正常聊天';
        let currentSeakingPersona = null;
        
        // 模式切换
        document.querySelectorAll('.persona-option').forEach(option => {
            option.addEventListener('click', async function() {
                // 移除所有active类
                document.querySelectorAll('.persona-option').forEach(opt => opt.classList.remove('active'));
                // 添加active类到当前选项
                this.classList.add('active');
                
                currentButtonType = this.dataset.buttonType;
                updateStatus();
                
                if (currentButtonType !== '正常聊天') {
                    await switchToSeakingMode(this.textContent);
                } else {
                    addSystemMessage('已切换到正常聊天模式');
                    currentSeakingPersona = null;
                }
            });
        });
        
        async function switchToSeakingMode(modeText) {
            try {
                const personasResponse = await fetch('/seaking/personas');
                if (personasResponse.ok) {
                    const personasData = await personasResponse.json();
                    const config = personasData[currentButtonType];
                    if (config && config.personas) {
                        // 随机选择一个人设
                        const randomPersona = config.personas[Math.floor(Math.random() * config.personas.length)];
                        currentSeakingPersona = {
                            button_type: currentButtonType,
                            persona: randomPersona,
                            gender: config.default_gender,
                            user_gender: config.user_gender,
                            challenge_type: config.challenge_type
                        };
                        console.log('获取新人设:', currentSeakingPersona);
                        
                        // 显示人设说明
                        addSystemMessage(`已切换到 ${modeText} 模式，准备开始海王对战！\n\n🎭 本次对战海王：${randomPersona}`);
                        
                        // 自动发送第一句对话
                        setTimeout(() => {
                            sendFirstMessage();
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('获取人设失败:', error);
                addSystemMessage(`已切换到 ${modeText} 模式，准备开始海王对战！`);
            }
        }
        
        async function sendFirstMessage() {
            if (!currentSeakingPersona) return;
            
            try {
                const requestBody = {
                    message: '你好',
                    button_type: currentButtonType,
                    seaking_score: 0,
                    is_first_seaking: true,
                    persona: currentSeakingPersona.persona,
                    gender: currentSeakingPersona.gender,
                    user_gender: currentSeakingPersona.user_gender,
                    challenge_type: currentSeakingPersona.challenge_type
                };
                
                console.log('发送请求参数:', requestBody);
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // 添加用户消息
                    addMessage('你好', 'user');
                    
                    // 添加AI回复
                    addMessage(data.response, 'ai');
                }
            } catch (error) {
                console.error('发送消息失败:', error);
                addMessage('发送消息失败', 'system');
            }
        }
        
        function addSystemMessage(text) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        function addMessage(text, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.style.margin = '10px 0';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '8px';
            
            if (sender === 'user') {
                messageDiv.style.backgroundColor = '#007bff';
                messageDiv.style.color = 'white';
                messageDiv.style.textAlign = 'right';
                messageDiv.textContent = `你: ${text}`;
            } else if (sender === 'ai') {
                messageDiv.style.backgroundColor = '#f8f9fa';
                messageDiv.style.border = '1px solid #ddd';
                messageDiv.style.whiteSpace = 'pre-wrap';
                messageDiv.textContent = `拽姐: ${text}`;
            } else {
                messageDiv.style.backgroundColor = '#ffc107';
                messageDiv.style.color = 'black';
                messageDiv.textContent = `系统: ${text}`;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        function updateStatus() {
            document.getElementById('currentStatus').textContent = `模式: ${currentButtonType}`;
            document.getElementById('currentPersona').textContent = `人设: ${currentSeakingPersona ? currentSeakingPersona.persona : '无'}`;
        }
        
        function testPersonaFetch() {
            fetch('/seaking/personas')
                .then(response => response.json())
                .then(data => {
                    console.log('人设数据:', data);
                    addSystemMessage('人设数据获取成功，请查看控制台');
                })
                .catch(error => {
                    console.error('获取人设数据失败:', error);
                    addSystemMessage('获取人设数据失败');
                });
        }
        
        function clearChat() {
            document.getElementById('chatArea').innerHTML = '';
        }
        
        // 初始化
        document.querySelector('[data-button-type="正常聊天"]').classList.add('active');
    </script>
</body>
</html>
