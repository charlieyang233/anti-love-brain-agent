<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·ç‹å¯¹æˆ˜æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .persona-option {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .persona-option:hover {
            background: #e0e0e0;
        }
        .persona-option.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        .system-message {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .chat-area {
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>æµ·ç‹å¯¹æˆ˜å‰ç«¯æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æ¨¡å¼é€‰æ‹©</h3>
        <div class="persona-option" data-button-type="æ­£å¸¸èŠå¤©">ğŸ’¬ æ­£å¸¸èŠå¤©</div>
        <div class="persona-option" data-button-type="ğŸŒŠå¯¹æˆ˜æµ·ç‹">ğŸŒŠ å¯¹æˆ˜æµ·ç‹</div>
        <div class="persona-option" data-button-type="ğŸµåèŒ¶è‰ºå¤§å¸ˆ">ğŸµ åèŒ¶è‰ºå¤§å¸ˆ</div>
        <div class="persona-option" data-button-type="ğŸŒˆå†³æˆ˜é€šè®¯å½•ä¹‹å·…">ğŸŒˆ å†³æˆ˜é€šè®¯å½•ä¹‹å·…</div>
    </div>
    
    <div class="test-section">
        <h3>å½“å‰çŠ¶æ€</h3>
        <div id="currentStatus">æ¨¡å¼: æ­£å¸¸èŠå¤©</div>
        <div id="currentPersona">äººè®¾: æ— </div>
    </div>
    
    <div class="test-section">
        <h3>èŠå¤©åŒºåŸŸ</h3>
        <div id="chatArea" class="chat-area"></div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•æŒ‰é’®</h3>
        <button onclick="testPersonaFetch()">æµ‹è¯•è·å–äººè®¾</button>
        <button onclick="clearChat()">æ¸…ç©ºèŠå¤©</button>
    </div>

    <script>
        let currentButtonType = 'æ­£å¸¸èŠå¤©';
        let currentSeakingPersona = null;
        
        // æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll('.persona-option').forEach(option => {
            option.addEventListener('click', async function() {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.persona-option').forEach(opt => opt.classList.remove('active'));
                // æ·»åŠ activeç±»åˆ°å½“å‰é€‰é¡¹
                this.classList.add('active');
                
                currentButtonType = this.dataset.buttonType;
                updateStatus();
                
                if (currentButtonType !== 'æ­£å¸¸èŠå¤©') {
                    await switchToSeakingMode(this.textContent);
                } else {
                    addSystemMessage('å·²åˆ‡æ¢åˆ°æ­£å¸¸èŠå¤©æ¨¡å¼');
                    currentSeakingPersona = null;
                }
            });
        });
        
        async function switchToSeakingMode(modeText) {
            try {
                const personasResponse = await fetch('/seaking/personas');
                if (personasResponse.ok) {
                    const personasData = await personasResponse.json();
                    const config = personasData[currentButtonType];
                    if (config && config.personas) {
                        // éšæœºé€‰æ‹©ä¸€ä¸ªäººè®¾
                        const randomPersona = config.personas[Math.floor(Math.random() * config.personas.length)];
                        currentSeakingPersona = {
                            button_type: currentButtonType,
                            persona: randomPersona,
                            gender: config.default_gender,
                            user_gender: config.user_gender,
                            challenge_type: config.challenge_type
                        };
                        console.log('è·å–æ–°äººè®¾:', currentSeakingPersona);
                        
                        // æ˜¾ç¤ºäººè®¾è¯´æ˜
                        addSystemMessage(`å·²åˆ‡æ¢åˆ° ${modeText} æ¨¡å¼ï¼Œå‡†å¤‡å¼€å§‹æµ·ç‹å¯¹æˆ˜ï¼\n\nğŸ­ æœ¬æ¬¡å¯¹æˆ˜æµ·ç‹ï¼š${randomPersona}`);
                        
                        // è‡ªåŠ¨å‘é€ç¬¬ä¸€å¥å¯¹è¯
                        setTimeout(() => {
                            sendFirstMessage();
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('è·å–äººè®¾å¤±è´¥:', error);
                addSystemMessage(`å·²åˆ‡æ¢åˆ° ${modeText} æ¨¡å¼ï¼Œå‡†å¤‡å¼€å§‹æµ·ç‹å¯¹æˆ˜ï¼`);
            }
        }
        
        async function sendFirstMessage() {
            if (!currentSeakingPersona) return;
            
            try {
                const requestBody = {
                    message: 'ä½ å¥½',
                    button_type: currentButtonType,
                    seaking_score: 0,
                    is_first_seaking: true,
                    persona: currentSeakingPersona.persona,
                    gender: currentSeakingPersona.gender,
                    user_gender: currentSeakingPersona.user_gender,
                    challenge_type: currentSeakingPersona.challenge_type
                };
                
                console.log('å‘é€è¯·æ±‚å‚æ•°:', requestBody);
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    addMessage('ä½ å¥½', 'user');
                    
                    // æ·»åŠ AIå›å¤
                    addMessage(data.response, 'ai');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                addMessage('å‘é€æ¶ˆæ¯å¤±è´¥', 'system');
            }
        }
        
        function addSystemMessage(text) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        function addMessage(text, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.style.margin = '10px 0';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '8px';
            
            if (sender === 'user') {
                messageDiv.style.backgroundColor = '#007bff';
                messageDiv.style.color = 'white';
                messageDiv.style.textAlign = 'right';
                messageDiv.textContent = `ä½ : ${text}`;
            } else if (sender === 'ai') {
                messageDiv.style.backgroundColor = '#f8f9fa';
                messageDiv.style.border = '1px solid #ddd';
                messageDiv.style.whiteSpace = 'pre-wrap';
                messageDiv.textContent = `æ‹½å§: ${text}`;
            } else {
                messageDiv.style.backgroundColor = '#ffc107';
                messageDiv.style.color = 'black';
                messageDiv.textContent = `ç³»ç»Ÿ: ${text}`;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        function updateStatus() {
            document.getElementById('currentStatus').textContent = `æ¨¡å¼: ${currentButtonType}`;
            document.getElementById('currentPersona').textContent = `äººè®¾: ${currentSeakingPersona ? currentSeakingPersona.persona : 'æ— '}`;
        }
        
        function testPersonaFetch() {
            fetch('/seaking/personas')
                .then(response => response.json())
                .then(data => {
                    console.log('äººè®¾æ•°æ®:', data);
                    addSystemMessage('äººè®¾æ•°æ®è·å–æˆåŠŸï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
                })
                .catch(error => {
                    console.error('è·å–äººè®¾æ•°æ®å¤±è´¥:', error);
                    addSystemMessage('è·å–äººè®¾æ•°æ®å¤±è´¥');
                });
        }
        
        function clearChat() {
            document.getElementById('chatArea').innerHTML = '';
        }
        
        // åˆå§‹åŒ–
        document.querySelector('[data-button-type="æ­£å¸¸èŠå¤©"]').classList.add('active');
    </script>
</body>
</html>
