<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè€æ - ä½ çš„èµ›åšåæ‹çˆ±è„‘é—ºèœœæ­å­ Agent</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="chat-container">
        <!-- é¡¶éƒ¨åŒºåŸŸ - ç²¾ç®€è®¾è®¡ -->
        <div class="chat-header">
            <div class="header-left">
                <div class="chat-title">
                    AIè€æ ğŸ’œ
                    <span id="personaDisplay" class="persona-status">ğŸ’¬ æ­£å¸¸èŠå¤©</span>
                </div>
                <div class="chat-subtitle">ä½ çš„èµ›åšåæ‹çˆ±è„‘é—ºèœœæ­å­ - æ¯’èˆŒ/å…«å¦/åæ§½/æ‹çˆ±é¡¾é—®</div>
            </div>
            
            <div class="header-right">
                <!-- æ‹çˆ±è„‘æŒ‡æ•° - æ‰©å±•ç‰ˆæœ¬ -->
                <div class="love-brain-indicator love-brain-hidden" id="loveBrainIndicator">
                    <div class="love-brain-compact">
                        <div class="meter-header">
                            <span>æ‹çˆ±è„‘æŒ‡æ•°ï¼š<span id="meterValue">--</span></span>
                            <span class="meter-level" id="meterLevel">æœªæ£€æµ‹</span>
                        </div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="meterFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- è®°å¿†çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="memory-indicator" id="memoryIndicator" title="ç‚¹å‡»æŸ¥çœ‹è®°å¿†è¯¦æƒ…">
                    <div class="memory-compact">
                        <span class="memory-icon">ğŸ§ </span>
                        <span class="memory-text">è®°å¿†: <span id="memoryRounds">0</span>è½®</span>
                        <span class="memory-usage" id="memoryUsage">0%</span>
                    </div>
                </div>
                
                <button class="new-session-button" id="newSessionButton">ğŸ”„ æ–°ä¼šè¯</button>
            </div>
        </div>
        
        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-avatar">æ‹½</div>
                <div class="message-content">
                    <div class="typewriter" id="welcomeMessage"></div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-container">
            <div class="persona-selector">
                <span class="persona-label">æ¨¡å¼:</span>
                <div class="persona-option active" data-persona="">æ­£å¸¸èŠå¤©</div>
                <div class="persona-option" data-persona="é«˜å†·å­¦éœ¸å‹">æµ·ç‹æ¨¡æ‹Ÿ-å­¦éœ¸</div>
                <div class="persona-option" data-persona="æ¸©æŸ”æš–ç”·å‹">æµ·ç‹æ¨¡æ‹Ÿ-æš–ç”·</div>
                <div class="persona-option" data-persona="éœ¸é“æ€»è£å‹">æµ·ç‹æ¨¡æ‹Ÿ-æ€»è£</div>
            </div>
            <div class="chat-input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="è·Ÿæ‹½å§è¯´è¯´ä½ çš„å›°æ‰°å§..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPersona = '';
        let isTyping = false;
        let conversationHistory = [];

        // DOM å…ƒç´ 
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const personaOptions = document.querySelectorAll('.persona-option');
        const personaDisplay = document.getElementById('personaDisplay');
        const newSessionButton = document.getElementById('newSessionButton');
        const welcomeMessage = document.getElementById('welcomeMessage');
        
        // æ‹çˆ±è„‘æŒ‡æ•°ç›¸å…³å…ƒç´ 
        const loveBrainIndicator = document.getElementById('loveBrainIndicator');
        const meterFill = document.getElementById('meterFill');
        const meterLevel = document.getElementById('meterLevel');
        const meterValue = document.getElementById('meterValue');

        // è®°å¿†çŠ¶æ€ç›¸å…³å…ƒç´ 
        const memoryIndicator = document.getElementById('memoryIndicator');
        const memoryRounds = document.getElementById('memoryRounds');
        const memoryUsage = document.getElementById('memoryUsage');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            typeWelcomeMessage();
            chatInput.focus();
            autoResizeTextarea();
            // åŠ è½½è®°å¿†çŠ¶æ€
            loadMemoryStats();
        });

        // æ¬¢è¿æ¶ˆæ¯æ‰“å­—æœºæ•ˆæœ
        function typeWelcomeMessage() {
            const messages = [
                "ğŸ˜ˆ è€¶æ–¯â€”â€”è«æ‹‰ï¼é›†ç¾å¥½ä¹…ä¸è§å•Šï¼\n\nå§æ˜¯ä½ çš„æ¯’èˆŒé“å­'è€æ'ğŸ’œï¼æœ‰å•¥æƒ…æ„Ÿå›°æ‰°å°½ç®¡æ¥åæ§½ï¼ä½ è¦æƒ³ç»ƒç»ƒåPUAï¼Œä¹Ÿå¯ä»¥è¯•è¯•æµ·ç‹æ¨¡æ‹Ÿæ¨¡å¼ï¼Œå§è·Ÿä½ æ¼”æ¼”~"
            ];
            
            let messageIndex = 0;
            let charIndex = 0;
            
            function typeChar() {
                if (messageIndex < messages.length) {
                    if (charIndex < messages[messageIndex].length) {
                        const char = messages[messageIndex].charAt(charIndex);
                        welcomeMessage.textContent += char;
                        charIndex++;
                        setTimeout(typeChar, 30);
                    } else {
                        // å½“å‰æ¶ˆæ¯å®Œæˆï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ¶ˆæ¯
                        messageIndex++;
                        charIndex = 0;
                        if (messageIndex < messages.length) {
                            welcomeMessage.textContent += '\n';
                            setTimeout(typeChar, 800);
                        }
                        // æ‰€æœ‰æ¶ˆæ¯å®Œæˆï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†
                    }
                }
            }
            
            typeChar();
        }

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        function autoResizeTextarea() {
            chatInput.addEventListener('input', function() {
                // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                const currentScrollTop = chatMessages.scrollTop;
                
                // ä¸´æ—¶è®¾ç½®ä¸ºautoæ¥è®¡ç®—æ‰€éœ€é«˜åº¦
                const currentHeight = this.style.height;
                this.style.height = 'auto';
                const newHeight = Math.min(this.scrollHeight, 120);
                
                // å¹³æ»‘è¿‡æ¸¡åˆ°æ–°é«˜åº¦
                this.style.height = newHeight + 'px';
                
                // æ¢å¤æ»šåŠ¨ä½ç½®ï¼Œé¿å…è·³åŠ¨
                chatMessages.scrollTop = currentScrollTop;
            });
        }

        // è·å–æ¨¡å¼æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå¸¦emojiï¼‰
        function getPersonaDisplayText(text, persona) {
            if (!persona) {
                return 'ğŸ’¬ ' + text;
            } else {
                return 'ğŸ˜ˆ ' + text;
            }
        }

        // äººæ ¼åˆ‡æ¢
        personaOptions.forEach(option => {
            option.addEventListener('click', function() {
                personaOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentPersona = this.dataset.persona;
                personaDisplay.textContent = getPersonaDisplayText(this.textContent, currentPersona);
                
                // æµ·ç‹æ¨¡å¼ç‰¹æ®Šå¤„ç†
                if (currentPersona) {
                    addSystemMessage(`å·²åˆ‡æ¢åˆ° ${this.textContent} æ¨¡å¼`);
                } else {
                    addSystemMessage('å·²åˆ‡æ¢åˆ°æ­£å¸¸èŠå¤©æ¨¡å¼');
                }
            });
        });

        // å‘é€æ¶ˆæ¯
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // æ–°ä¼šè¯
        newSessionButton.addEventListener('click', async function() {
            try {
                // è°ƒç”¨åç«¯é‡ç½®ä¼šè¯
                const response = await fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                // é‡ç½®å‰ç«¯çŠ¶æ€
                conversationHistory = [];
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-avatar">æ‹½</div>
                        <div class="message-content">å¼€å§‹æ–°çš„å¯¹è¯å§ï¼æˆ‘ä¼šç»§ç»­å¸®ä½ ä¿æŒç†æ™ºæ¸…é†’ ğŸ˜‰</div>
                    </div>
                `;
                resetLoveBrainMeter();
                resetMemoryStats();
                
                // æ›´æ–°è®°å¿†çŠ¶æ€
                if (data.memory_stats) {
                    updateMemoryStats(data.memory_stats);
                }
                
                scrollToBottom();
                
                console.log('ä¼šè¯é‡ç½®æˆåŠŸ:', data);
            } catch (error) {
                console.error('é‡ç½®ä¼šè¯å¤±è´¥:', error);
                // é™çº§å¤„ç†ï¼šä»…å‰ç«¯é‡ç½®
                conversationHistory = [];
                chatMessages.innerHTML = `
                    <div class="message ai">
                        <div class="message-avatar">æ‹½</div>
                        <div class="message-content">å¼€å§‹æ–°çš„å¯¹è¯å§ï¼æˆ‘ä¼šç»§ç»­å¸®ä½ ä¿æŒç†æ™ºæ¸…é†’ ğŸ˜‰</div>
                    </div>
                `;
                resetLoveBrainMeter();
                resetMemoryStats();
                scrollToBottom();
            }
        });

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isTyping) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            chatInput.value = '';
            // å¹³æ»‘é‡ç½®åˆ°åˆå§‹é«˜åº¦
            chatInput.style.height = '60px';

            // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            showTypingIndicator();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        persona: currentPersona,
                        history: conversationHistory
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    hideTypingIndicator();
                    
                    // æ›´æ–°æ‹çˆ±è„‘æŒ‡æ•°
                    if (data.love_brain_index !== undefined) {
                        updateLoveBrainMeter(data.love_brain_index, data.love_brain_level);
                    }
                    
                    // æ›´æ–°è®°å¿†çŠ¶æ€
                    if (data.memory_stats) {
                        updateMemoryStats(data.memory_stats);
                    }
                    
                    // æ·»åŠ AIå›å¤
                    if (currentPersona && currentPersona.trim() !== '') {
                        // æµ·ç‹æ¨¡æ‹Ÿæ¨¡å¼ - è§£æä¸‰æ®µå¼è¾“å‡º
                        await parseSeakingResponse(data.response);
                    } else {
                        // æ™®é€šèŠå¤©æ¨¡å¼
                        await addMessageWithTypewriter(data.response, 'ai');
                    }
                    
                    // æ›´æ–°å¯¹è¯å†å²
                    conversationHistory.push(
                        { role: 'user', content: message },
                        { role: 'assistant', content: data.response }
                    );
                } else {
                    hideTypingIndicator();
                    addMessage(`æŠ±æ­‰ï¼Œå‡ºç°äº†é”™è¯¯ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'ai');
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•', 'ai');
                console.error('Error:', error);
            }
        }

        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'ä½ ' : 
                                sender === 'seaking' ? 'ç‹' : 'æ‹½';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
            return messageDiv;
        }

        async function addMessageWithTypewriter(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'ä½ ' : 
                                sender === 'seaking' ? 'ç‹' : 'æ‹½';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const typewriter = document.createElement('div');
            typewriter.className = 'typewriter';
            messageContent.appendChild(typewriter);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // æ‰“å­—æœºæ•ˆæœ
            let i = 0;
            
            function typeChar() {
                if (i < content.length) {
                    typewriter.textContent += content.charAt(i);
                    i++;
                    // å‡å°‘æ»šåŠ¨é¢‘ç‡ï¼Œåªåœ¨æ¢è¡Œæ—¶æ»šåŠ¨
                    if (content.charAt(i-1) === '\n') {
                        scrollToBottom();
                    }
                    setTimeout(typeChar, 30);
                } else {
                    // æ‰“å­—å®Œæˆåæœ€ç»ˆæ»šåŠ¨
                    scrollToBottom();
                }
            }
            
            typeChar();
        }

        // è§£ææµ·ç‹æ¨¡æ‹Ÿçš„ä¸‰æ®µå¼è¾“å‡º
        async function parseSeakingResponse(content) {
            // è§£ææµ·ç‹å›å¤
            const seakingMatch = content.match(/ã€æµ·ç‹ã€‘[ï¼š"]*([^ã€]*)/);
            if (seakingMatch) {
                let seakingText = seakingMatch[1].trim();
                // æ¸…ç†æ ¼å¼
                seakingText = seakingText.replace(/^[ï¼š""\s]+/, '');
                seakingText = seakingText.replace(/[""]\s*$/, '');
                seakingText = seakingText.replace(/\s*ï¼ˆ[^ï¼‰]*ï¼‰.*$/, '');
                seakingText = seakingText.replace(/\s+/g, ' ').trim();
                
                if (seakingText) {
                    await addSeakingMessage(seakingText);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // è§£ææ‹½å§æ—ç™½
            const commentMatch = content.match(/ã€æ‹½å§æ—ç™½ã€‘([^ã€]*)/);
            if (commentMatch) {
                const commentText = commentMatch[1].trim();
                if (commentText) {
                    addSystemMessage(commentText);
                }
            }
        }

        async function addSeakingMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message seaking';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ç‹';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const typewriter = document.createElement('div');
            typewriter.className = 'typewriter';
            messageContent.appendChild(typewriter);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            
            // æ‰“å­—æœºæ•ˆæœ
            let i = 0;
            
            function typeSeakingChar() {
                if (i < content.length) {
                    typewriter.textContent += content.charAt(i);
                    i++;
                    if (content.charAt(i-1) === '\n') {
                        scrollToBottom();
                    }
                    setTimeout(typeSeakingChar, 30);
                } else {
                    scrollToBottom();
                }
            }
            
            typeSeakingChar();
        }

        function addSystemMessage(content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ç³»';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            scrollToBottom();
        }

        function showTypingIndicator() {
            isTyping = true;
            sendButton.disabled = true;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = currentPersona ? 'ç‹' : 'æ‹½';
            
            const indicatorContent = document.createElement('div');
            indicatorContent.className = 'typing-indicator';
            
            const dots = document.createElement('div');
            dots.className = 'typing-dots';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'typing-dot';
                dots.appendChild(dot);
            }
            
            indicatorContent.appendChild(dots);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(indicatorContent);
            chatMessages.appendChild(typingDiv);
            
            scrollToBottom();
        }

        function hideTypingIndicator() {
            isTyping = false;
            sendButton.disabled = false;
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // æ‹çˆ±è„‘æŒ‡æ•°æ›´æ–°å‡½æ•°
        function updateLoveBrainMeter(index, level) {
            loveBrainIndicator.classList.remove('love-brain-hidden');
            
            // æ›´æ–°æ•°å€¼
            meterValue.textContent = index;
            
            // è½¬æ¢ç­‰çº§æ˜¾ç¤ºæ ¼å¼
            let displayLevel = level || 'æœªçŸ¥';
            if (level === 'è½»') displayLevel = 'è½»åº¦';
            else if (level === 'ä¸­') displayLevel = 'ä¸­åº¦';
            else if (level === 'é‡') displayLevel = 'é‡åº¦';
            else if (level === 'å±é™©') displayLevel = 'å±é™©';
            
            meterLevel.textContent = displayLevel;
            
            // æ›´æ–°è¿›åº¦æ¡
            meterFill.style.width = `${index}%`;
            
            // æ›´æ–°ç­‰çº§æ ·å¼ - ä½¿ç”¨åŸå§‹çš„levelä½œä¸ºCSSç±»å
            meterLevel.className = 'meter-level';
            if (level) {
                meterLevel.classList.add(level);
            }
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            loveBrainIndicator.style.animation = 'pulse 0.5s ease-in-out';
            setTimeout(() => {
                loveBrainIndicator.style.animation = '';
            }, 500);
        }

        // é‡ç½®æ‹çˆ±è„‘æŒ‡æ•°
        function resetLoveBrainMeter() {
            loveBrainIndicator.classList.add('love-brain-hidden');
            meterFill.style.width = '0%';
            meterLevel.textContent = 'æœªæ£€æµ‹';
            meterLevel.className = 'meter-level';
            meterValue.textContent = '--';
        }

        // åŠ è½½è®°å¿†çŠ¶æ€
        async function loadMemoryStats() {
            try {
                const response = await fetch('/memory/stats');
                const data = await response.json();
                updateMemoryStats(data);
            } catch (error) {
                console.error('åŠ è½½è®°å¿†çŠ¶æ€å¤±è´¥:', error);
                // ä¿æŒé»˜è®¤å€¼ä¸å˜
            }
        }

        // æ›´æ–°è®°å¿†çŠ¶æ€
        function updateMemoryStats(stats) {
            if (!stats) return;
            
            // æ›´æ–°è½®æ•°
            memoryRounds.textContent = stats.conversation_count || 0;
            
            // æ›´æ–°ä½¿ç”¨ç‡
            const usageRatio = stats.memory_usage_ratio || 0;
            const usagePercent = Math.round(usageRatio * 100);
            memoryUsage.textContent = `${usagePercent}%`;
            
            // æ›´æ–°æ ·å¼
            memoryUsage.className = 'memory-usage';
            if (usagePercent >= 80) {
                memoryUsage.classList.add('high');
            } else if (usagePercent >= 60) {
                memoryUsage.classList.add('medium');
            } else {
                memoryUsage.classList.add('low');
            }
            
            // æ›´æ–°æç¤ºä¿¡æ¯
            let tooltipText = `å¯¹è¯è½®æ•°: ${stats.conversation_count}\n`;
            tooltipText += `Tokenä½¿ç”¨: ${stats.estimated_tokens}/${stats.max_tokens}\n`;
            tooltipText += `ä½¿ç”¨ç‡: ${usagePercent}%`;
            
            if (stats.user_patterns && Object.keys(stats.user_patterns).length > 0) {
                tooltipText += '\nè¡Œä¸ºæ¨¡å¼: ' + Object.entries(stats.user_patterns)
                    .map(([pattern, count]) => `${pattern}(${count})`)
                    .join(', ');
            }
            
            memoryIndicator.title = tooltipText;
        }

        // è®°å¿†è¯¦æƒ…ç‚¹å‡»äº‹ä»¶
        memoryIndicator.addEventListener('click', async function() {
            try {
                const response = await fetch('/memory/summary');
                const data = await response.json();
                
                let message = `ğŸ§  æ™ºèƒ½è®°å¿†çŠ¶æ€:\n\n`;
                message += `ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:\n`;
                message += `â€¢ å¯¹è¯è½®æ•°: ${data.stats.conversation_count}\n`;
                message += `â€¢ Tokenä½¿ç”¨: ${data.stats.estimated_tokens}/${data.stats.max_tokens}\n`;
                message += `â€¢ ä½¿ç”¨ç‡: ${Math.round(data.stats.memory_usage_ratio * 100)}%\n`;
                
                if (data.context_summary) {
                    message += `\nğŸ“‹ ä¸Šä¸‹æ–‡æ‘˜è¦:\n${data.context_summary}`;
                }
                
                if (data.stats.user_patterns && Object.keys(data.stats.user_patterns).length > 0) {
                    message += `\n\nğŸ¯ è¡Œä¸ºæ¨¡å¼åˆ†æ:\n`;
                    Object.entries(data.stats.user_patterns).forEach(([pattern, count]) => {
                        message += `â€¢ ${pattern}: ${count}æ¬¡\n`;
                    });
                }
                
                alert(message);
            } catch (error) {
                console.error('è·å–è®°å¿†è¯¦æƒ…å¤±è´¥:', error);
            }
        });

        // é‡ç½®è®°å¿†çŠ¶æ€
        function resetMemoryStats() {
            memoryRounds.textContent = '0';
            memoryUsage.textContent = '0%';
            memoryUsage.className = 'memory-usage low';
            memoryIndicator.title = 'è®°å¿†å·²é‡ç½®';
        }
    </script>
</body>
</html>
