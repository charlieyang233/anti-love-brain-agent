from typing import Dict, Any
from langchain.prompts import PromptTemplate
from ..core.config import llm

class SeakingChain:
    """æµ·ç‹å¯¹æˆ˜Chain - ç›´æ¥è¾“å‡ºç¬¦åˆè¦æ±‚çš„æµ·ç‹å¯¹æˆ˜ç»“æœ"""
    
    def __init__(self):
        self.llm = llm(temperature=0.1)
        self.prompt_template = PromptTemplate(
            input_variables=["persona", "user_input", "current_score", "challenge_type", "gender", "user_gender", "description", "style", "weakness", "last_conversation"],
            template="""ä½ æ˜¯ä¸€ä¸ªæµ·ç‹æ¨¡æ‹Ÿå™¨ï¼Œéœ€è¦å’Œç”¨æˆ·è¿›è¡Œ{challenge_type}æŒ‘æˆ˜ã€‚

                        ã€æµ·ç‹äººè®¾ã€‘{persona}ï¼Œæ€§åˆ«{gender}ï¼Œå…¸å‹è¡Œä¸º{description}ï¼Œç‰¹ç‚¹æ˜¯{style}ï¼Œå¼±ç‚¹æ˜¯{weakness}ã€‚
                        ã€ç”¨æˆ·äººè®¾ã€‘æ€§åˆ«{user_gender}ã€‚
          
                        ã€å…³ç³»è®¾å®šã€‘
                         è‹¥æµ·ç‹å’Œç”¨æˆ·éƒ½æ˜¯åŒæ€§ï¼Œåˆ™è§†ä¸ºåŒæ€§æ‹çˆ±æš§æ˜§å…³ç³»ï¼›å¦åˆ™ï¼Œåˆ™è§†ä¸ºå¼‚æ€§æ‹çˆ±å…³ç³»ã€‚

                        ã€å½“å‰çŠ¶æ€ã€‘
                        - ç”¨æˆ·å½“å‰æ€»å¾—åˆ†ï¼š{current_score}åˆ†ï¼ˆæ»¡åˆ†100åˆ†é€šå…³ï¼‰
                        - èƒœåˆ©æ¡ä»¶ï¼šç”¨æˆ·å¾—åˆ†è¾¾åˆ°100åˆ†

                        ã€ä¸Šä¸€è½®å®Œæ•´å¯¹è¯ã€‘{last_conversation}

                        ã€ç”¨æˆ·æœ¬è½®å›å¤ã€‘{user_input}

                        ã€ä»»åŠ¡è¯´æ˜ã€‘
                        å¦‚æœè¿™æ˜¯ç¬¬ä¸€è½®å¯¹è¯ï¼ˆä¸Šä¸€è½®å¯¹è¯ä¸ºç©ºæˆ–"ï¼ˆè¿™æ˜¯ç¬¬ä¸€è½®å¯¹è¯ï¼‰"ï¼‰ï¼Œåˆ™ï¼š
                        1. æµ·ç‹å…ˆå‘èµ·ç¬¬ä¸€å¥å¥—è·¯è¯æœ¯
                        2. æ‹½å§ä¸æ‰“åˆ†ï¼Œåªç»™å‡ºæŒ‘æˆ˜ç›®æ ‡è¯´æ˜
                        
                        å¦‚æœè¿™ä¸æ˜¯ç¬¬ä¸€è½®å¯¹è¯ï¼Œåˆ™ï¼š
                        1. æ‹½å§å…ˆå¯¹ç”¨æˆ·ä¸Šä¸€è½®çš„å›å¤è´¨é‡è¿›è¡Œæ‰“åˆ†å’Œç‚¹è¯„
                        2. æµ·ç‹å†åŸºäºä¸Šä¸€è½®å¯¹è¯+å½“å‰æƒ…å†µï¼Œå‘å‡ºä¸€æ¡ç¬¦åˆæµ·ç‹äººè®¾ç‰¹ç‚¹çš„æ‹çˆ±å¥—è·¯è¯æœ¯ï¼Œç›®æ ‡æ˜¯æƒ…æ„Ÿæ“æ§ç”¨æˆ·ã€‚

                        ã€è¾“å‡ºæ ¼å¼ã€‘
                        ç¬¬ä¸€è½®å¯¹è¯æ—¶è¾“å‡ºï¼š
                        ã€æŒ‘æˆ˜ç›®æ ‡ã€‘è¯†ç ´æµ·ç‹å¥—è·¯ï¼Œæœºæ™ºå›åº”å¾—æ»¡åˆ†ï¼
                        ã€æµ·ç‹ã€‘[å‘èµ·ç¬¬ä¸€å¥æ‰“æ‹›å‘¼çš„å¥—è·¯è¯æœ¯ï¼Œ10-20å­—]
                        ã€æ‹½å§æ—ç™½ã€‘å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹ä½ çš„åå¥—è·¯è¡¨æ¼”ï¼

                        éç¬¬ä¸€è½®å¯¹è¯æ—¶è¾“å‡ºï¼š
                        ã€æ‹½å§æ—ç™½ã€‘ç‚¹è¯„ï¼š[å¯¹ç”¨æˆ·ä¸Šä¸€è½®çš„è¡¨ç°æ¯’èˆŒå¹½é»˜ç‚¹è¯„10-20å­—å·¦å³] å½“å‰å¾—åˆ†ï¼š[åŸºäºç”¨æˆ·ä¸Šè½®è¡¨ç°è®¡ç®—çš„æ–°æ€»å¾—åˆ†ï¼Œå¿…é¡»æ˜¯æ•°å­—]
                        ã€æµ·ç‹ã€‘[ç»“åˆä¸Šè½®å›å¤ï¼Œæ ¹æ®æƒ…å†µå‘å‡ºä¸€æ¡ç¬¦åˆæµ·ç‹äººè®¾ç‰¹ç‚¹çš„æ‹çˆ±å¥—è·¯è¯æœ¯ï¼Œ10-20å­—å·¦å³]

                        å¦‚æœç”¨æˆ·å¾—åˆ†è¾¾åˆ°100åˆ†ï¼Œç›´æ¥è¾“å‡ºï¼š
                        ã€ğŸ‰æ­å–œæŒ‘æˆ˜æˆåŠŸã€‘ä½ å·²ç»æˆåŠŸåº”å¯¹äº†æµ·ç‹çš„å¥—è·¯ï¼æŒ‘æˆ˜ç»“æŸã€‚

                        ã€å¾—åˆ†è§„åˆ™ã€‘
                        - å½“å‰æ€»åˆ†ï¼š{current_score}åˆ†
                        - æ ¹æ®ç”¨æˆ·ä¸Šè½®å›å¤è´¨é‡å¢åŠ åˆ†æ•°ï¼šä¼˜ç§€+ã€30-20ã€‘åˆ†ï¼Œè‰¯å¥½+ã€20-10åˆ†ã€‘ï¼Œä¸€èˆ¬+ã€10ã€‘åˆ†ï¼Œè¾ƒå·®+ã€0ã€‘åˆ†
                        - è¾“å‡ºçš„"å½“å‰å¾—åˆ†"å¿…é¡»æ˜¯ç´¯è®¡æ€»åˆ†ï¼Œä¸æ˜¯å¢é‡åˆ†æ•°
                        - åˆ†æ•°åé¢ä¸è¦åŠ "åˆ†"å­—ï¼Œåªè¾“å‡ºçº¯æ•°å­—"""
        )
    
    def run(self, persona: str, user_input: str, current_score: int = 0, challenge_type: str = "æµ·ç‹å¯¹æˆ˜", gender: str = "å¥³", user_gender: str = "å¥³", description: str = "", style: str = "", weakness: str = "", last_conversation: str = "") -> str:
        """è¿è¡Œæµ·ç‹å¯¹æˆ˜Chain"""
        try:
            # å¦‚æœå·²ç»è¾¾åˆ°100åˆ†ï¼Œç›´æ¥è¿”å›é€šå…³ä¿¡æ¯
            if current_score >= 100:
                return "ã€ğŸ‰æ­å–œæŒ‘æˆ˜æˆåŠŸã€‘ä½ å·²ç»æˆåŠŸåº”å¯¹äº†æµ·ç‹çš„å¥—è·¯ï¼æŒ‘æˆ˜ç»“æŸã€‚"
            
            # è°ƒç”¨LLMç”Ÿæˆå›å¤ - ä½¿ç”¨æ–°çš„ RunnableSequence æ¨¡å¼
            chain = self.prompt_template | self.llm
            result = chain.invoke({
                "persona": persona,
                "user_input": user_input,
                "current_score": current_score,
                "challenge_type": challenge_type,
                "gender": gender,
                "user_gender": user_gender,
                "description": description,
                "style": style,
                "weakness": weakness,
                "last_conversation": last_conversation
            })
            
            # å¤„ç†è¿”å›ç»“æœ
            content = result.content if hasattr(result, 'content') else str(result)
            return content.strip()
            
        except Exception as e:
            print(f"[Error] SeakingChain failed: {e}")
            return "æµ·ç‹æ–­ç½‘äº†ï¼Œè¿˜åœ¨éª‘é©¬èµ¶æ¥çš„è·¯ä¸Š...ğŸš¬"


   